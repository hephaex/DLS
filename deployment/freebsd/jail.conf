# FreeBSD Jail Configuration for CLAUDE DLS
# Production deployment configuration for diskless boot system

# Global jail configuration
exec.start = "/bin/sh /etc/rc";
exec.stop = "/bin/sh /etc/rc.shutdown";
exec.clean;
mount.devfs;
mount.fdescfs;
devfs_ruleset = "4";
enforce_statfs = "2";

# Network configuration
interface = "em0";
host.hostname = "$name.claude.local";
ip4.addr = "$ip";

# Security settings
securelevel = "2";
children.max = "10";
persist;

# CLAUDE DLS Main Service Jail
claude_dls {
    $ip = "10.0.1.10/24";
    path = "/jails/claude_dls";
    
    # Mount points for application data
    mount += "/zpool/claude_dls $path/opt/claude_dls nullfs rw 0 0";
    mount += "/zpool/images $path/var/lib/claude_dls/images nullfs rw 0 0";
    mount += "/var/log/claude_dls $path/var/log/claude_dls nullfs rw 0 0";
    
    # Environment variables
    env += "RUST_LOG=info";
    env += "CLAUDE_CONFIG_PATH=/opt/claude_dls/config";
    env += "CLAUDE_DATA_PATH=/var/lib/claude_dls";
    
    # Resource limits
    rlimits.cpu = "unlimited";
    rlimits.data = "8G";
    rlimits.nproc = "1000";
    rlimits.fsize = "unlimited";
    
    # Additional parameters for production
    allow.raw_sockets = "1";
    allow.chflags = "1";
    allow.mount = "1";
    allow.mount.nullfs = "1";
    allow.mount.zfs = "1";
    
    exec.poststart = "/usr/local/bin/claude_dls_start.sh";
    exec.prestop = "/usr/local/bin/claude_dls_stop.sh";
}

# Database Service Jail (PostgreSQL)
claude_db {
    $ip = "10.0.1.11/24";
    path = "/jails/claude_db";
    
    # Database storage
    mount += "/zpool/database $path/var/db/postgres nullfs rw 0 0";
    mount += "/var/log/postgresql $path/var/log/postgresql nullfs rw 0 0";
    
    # PostgreSQL configuration
    env += "PGDATA=/var/db/postgres/data14";
    env += "POSTGRES_USER=claude_dls";
    env += "POSTGRES_DB=claude_dls_production";
    
    # Resource limits for database
    rlimits.data = "16G";
    rlimits.nproc = "500";
    
    exec.poststart = "/usr/local/etc/rc.d/postgresql onestart";
    exec.prestop = "/usr/local/etc/rc.d/postgresql onestop";
}

# Monitoring Service Jail (Prometheus/Grafana)
claude_monitor {
    $ip = "10.0.1.12/24";
    path = "/jails/claude_monitor";
    
    # Monitoring data storage
    mount += "/zpool/monitoring $path/var/lib/prometheus nullfs rw 0 0";
    mount += "/zpool/grafana $path/var/lib/grafana nullfs rw 0 0";
    
    # Monitoring configuration
    env += "PROMETHEUS_CONFIG=/usr/local/etc/prometheus/prometheus.yml";
    env += "GRAFANA_DATA=/var/lib/grafana";
    
    # Resource limits
    rlimits.data = "4G";
    rlimits.nproc = "200";
    
    exec.poststart = "/usr/local/bin/monitoring_start.sh";
    exec.prestop = "/usr/local/bin/monitoring_stop.sh";
}

# TFTP Service Jail
claude_tftp {
    $ip = "10.0.1.13/24";
    path = "/jails/claude_tftp";
    
    # TFTP boot files
    mount += "/zpool/tftp $path/tftpboot nullfs rw 0 0";
    
    # TFTP configuration
    env += "TFTPD_ROOT=/tftpboot";
    env += "TFTPD_USER=tftp";
    
    # Network access for TFTP
    allow.raw_sockets = "1";
    
    # Resource limits
    rlimits.data = "512M";
    rlimits.nproc = "50";
}

# DHCP Service Jail
claude_dhcp {
    $ip = "10.0.1.14/24";
    path = "/jails/claude_dhcp";
    
    # DHCP configuration
    mount += "/zpool/dhcp $path/var/db/dhcp nullfs rw 0 0";
    
    # Network access for DHCP
    allow.raw_sockets = "1";
    
    # Resource limits
    rlimits.data = "256M";
    rlimits.nproc = "20";
}